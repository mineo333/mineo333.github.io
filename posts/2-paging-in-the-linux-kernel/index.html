<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Paging in the Linux Kernel" /><meta property="og:locale" content="en" /><meta name="description" content="Before I begin discussing the internals of the QogChamp exploit, I first need to discuss how the Linux kernel handles paging." /><meta property="og:description" content="Before I begin discussing the internals of the QogChamp exploit, I first need to discuss how the Linux kernel handles paging." /><link rel="canonical" href="https://mineo333.dev/posts/2-paging-in-the-linux-kernel/" /><meta property="og:url" content="https://mineo333.dev/posts/2-paging-in-the-linux-kernel/" /><meta property="og:site_name" content="mineo333/Sharad Khanna" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-29T12:30:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Paging in the Linux Kernel" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"Paging in the Linux Kernel","dateModified":"2022-04-30T16:50:08+00:00","datePublished":"2021-10-29T12:30:00+00:00","description":"Before I begin discussing the internals of the QogChamp exploit, I first need to discuss how the Linux kernel handles paging.","url":"https://mineo333.dev/posts/2-paging-in-the-linux-kernel/","mainEntityOfPage":{"@type":"WebPage","@id":"https://mineo333.dev/posts/2-paging-in-the-linux-kernel/"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>Paging in the Linux Kernel | mineo333/Sharad Khanna</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="mineo333/Sharad Khanna"><meta name="application-name" content="mineo333/Sharad Khanna"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/prof_pic.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">mineo333/Sharad Khanna</a></div><div class="site-subtitle font-italic">constantly in need of sleep</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mineo333" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sharad','mineo333.dev'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/khanna-sharad/" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/8877217/sharad-khanna" aria-label="stack-overflow" class="order-6" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Paging in the Linux Kernel</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Paging in the Linux Kernel</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> mineo333/Sharad Khanna </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 29, 2021, 12:30 PM +0000" >Oct 29, 2021<i class="unloaded">2021-10-29T12:30:00+00:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Apr 30, 2022, 12:50 PM -0400" >Apr 30<i class="unloaded">2022-04-30T16:50:08+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1777 words">9 min read</span></div></div><div class="post-content"><p>Before I begin discussing the internals of the QogChamp exploit, I first need to discuss how the Linux kernel handles paging.</p><p>This article will assume familiarity with paging as a concept.</p><h2 id="quick-refresher-on-paging">Quick Refresher on Paging</h2><p>Paging is how we establish a mapping that turns linear or virtual addresses into physical addresses. By using paging, we can do a variety of things such as isolate address spaces as well as prevent external fragmentation of memory.</p><p>In order to turn a linear address into a physical address, we need to do a page table walk as described below from Intel Manual Volume 3:</p><p><img data-proofer-ignore data-src="/assets/img/2/page-walk.png" alt="Paging Walk Diagram" /></p><p>Note that the directory pointers have 9-bit offsets instead of 10-bit offsets. If you’re used to programming 32-bit paging, then this might take you by surprise. As we will see later, the paging data structures are 8 bytes, so we can only fit 4096/8 = 512 = 2^9 paging data structures in a given directory. Thus, it is sufficient to have a 9 bit offset instead of a 10-bit offset. However, we still need a 12 bit offset into the frame.</p><h2 id="paging-in-the-cpu">Paging in the CPU</h2><p>Before I discuss paging in Linux, it is first important to get a grasp of how paging is handled in the CPU.</p><p>In order to get an understanding of paging in the CPU, we can reference the trusty Intel Developer Manual Volume 3.</p><p><img data-proofer-ignore data-src="/assets/img/2/paging-structures.png" alt="Paging Data Structures" /></p><p>Above is a picture of all the paging data structures in IA-32e (64 bit). There are 4 data structures that concern us: the CR3, the PDPTE, the PDE page table, and the 4 KiB page.</p><p>CR3 is a control register in the CPU that always points to the first PDPTE. This is where the page walk is started. The CR3 is swapped out at every context switch in order to enforce different address spaces.</p><p>The PDPTE is the first level of paging and contains a 12-bit aligned pointer to a page of PDEs. Typically, we use the first set of 10-bits in the linear address as an offset from the address in CR3 to find the relevant PDPTE.</p><p>The PDE is the second level of paging and contains a pointer 12-bit aligned pointer to a page of PTEs. Typically, we use the second set of 10 bits in the linear address as an offset from the address in the PDPTE to find the relevant PDE.</p><p>The third and final level of paging is the PTE. The PTE contains a 12-bit aligned pointer to a page frame. Typically, we use the third set of 10 bits in the linear address as an offset from the address in the PDE to find the relevant PTE.</p><p>The last 12 bits of a linear address are used to search through the 4 KiB page frame.</p><p>Another thing that you might notice is that in every paging data structure, the last 12 bits have a bunch of entries. These are known as flags and contain information about the state of the PTE. The one flag that concerns us is the dirty flag (Marked as D). This dirty flag is set to 1 by the hardware whenever the corresponding page frame is written to.</p><h2 id="paging-in-the-kernel">Paging in the Kernel</h2><p>Now that we have discussed paging as a concept and paging in the CPU, we can finally discuss paging in the Linux Kernel.</p><p>For the kernel, the PTE data structure does not provide sufficient information about a page. This is because, in the Linux Kernel, pages are associated with various additional structures such as page caches, slabs, and page pools. So, the kernel needs a place to put metadata regarding these structures. This is where <code class="language-plaintext highlighter-rouge">struct page</code> comes in. <code class="language-plaintext highlighter-rouge">struct page</code> is the Linux Kernel’s own representation of pages. In contrast to the PTE, the <code class="language-plaintext highlighter-rouge">struct page</code> is quite large, with each structure being 64 bytes.</p><p>These page structures contain a variety of extremely important fields, each of which deserves its own lengthy articles, but only a few concern us for the purposes of QogChamp.</p><p>The first field of importance is:</p><pre><code class="language-C">unsigned long flags
</code></pre><p>This is an unsigned 64 bit integer that contains the flags of a given page. The purpose of this field is to extend the flag portion of the PTE and provide a kernel developer with a much higher degree of control as well as more options on how to label their pages.</p><p>The possible flags that can go into <code class="language-plaintext highlighter-rouge">unsigned long flags</code> are detailed in <code class="language-plaintext highlighter-rouge">page-flags.h</code>. Below I have listed a shortlist of all the possible flags, but if you’re interested in the current flags that a page can have please check it out <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/page-flags.h">here</a>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="k">enum</span> <span class="n">pageflags</span> <span class="p">{</span>
	<span class="n">PG_locked</span><span class="p">,</span>		<span class="cm">/* Page is locked. Don't touch. */</span>
	<span class="n">PG_referenced</span><span class="p">,</span>
	<span class="n">PG_uptodate</span><span class="p">,</span>
	<span class="n">PG_dirty</span><span class="p">,</span>
	<span class="n">PG_lru</span><span class="p">,</span>
	<span class="n">PG_active</span><span class="p">,</span>
	<span class="n">PG_workingset</span><span class="p">,</span>
	<span class="n">PG_waiters</span><span class="p">,</span>		<span class="cm">/* Page has waiters, check its waitqueue. Must be bit #7 and in the same byte as "PG_locked" */</span>
	<span class="n">PG_error</span><span class="p">,</span>
	<span class="n">PG_slab</span><span class="p">,</span>
	<span class="n">PG_owner_priv_1</span><span class="p">,</span>	<span class="cm">/* Owner use. If pagecache, fs may use*/</span>
	<span class="n">PG_arch_1</span><span class="p">,</span>
	<span class="n">PG_reserved</span><span class="p">,</span>
	<span class="n">PG_private</span><span class="p">,</span>		<span class="cm">/* If pagecache, has fs-private data */</span>
	<span class="n">PG_private_2</span><span class="p">,</span>		<span class="cm">/* If pagecache, has fs aux data */</span>
	<span class="n">PG_writeback</span><span class="p">,</span>		<span class="cm">/* Page is under writeback */</span>
	<span class="n">PG_head</span><span class="p">,</span>		<span class="cm">/* A head page */</span>
	<span class="n">PG_mappedtodisk</span><span class="p">,</span>	<span class="cm">/* Has blocks allocated on-disk */</span>
	<span class="n">PG_reclaim</span><span class="p">,</span>		<span class="cm">/* To be reclaimed asap */</span>
	<span class="n">PG_swapbacked</span><span class="p">,</span>		<span class="cm">/* Page is backed by RAM/swap */</span>
	<span class="n">PG_unevictable</span>		<span class="cm">/* Page is "unevictable"  */</span>
<span class="p">};</span>
</pre></table></code></div></div><p>Out of these flags, only a few concern us. The first is <code class="language-plaintext highlighter-rouge">PG_uptodate</code>. <code class="language-plaintext highlighter-rouge">PG_uptodate</code> signifies that the page’s content is current and matches that on the disk. We will discuss what this means in greater detail as we discuss page and buffer caches.</p><p>The second is <code class="language-plaintext highlighter-rouge">PG_dirty</code>. <code class="language-plaintext highlighter-rouge">PG_dirty</code> is a flag that signifies that the page has been written to. It is <em>very</em> important to note that this flag is in no way correlated to the dirty bit on the PTE. The dirty bit on the PTE is set by the CPU automatically when a write occurs. <code class="language-plaintext highlighter-rouge">PG_dirty</code> is set by the kernel (Software). We will discuss later when we get into the details of QogChamp about why this distinction is important as well as under what conditions <code class="language-plaintext highlighter-rouge">PG_dirty</code> is set.</p><p>The third bit that is important is <code class="language-plaintext highlighter-rouge">PG_private</code>. We will get into this more when we get into the page cache, but what it means is that the private field in the page struct contains a series of <code class="language-plaintext highlighter-rouge">struct buffer_head</code>s.</p><p>The fourth bit that is important is <code class="language-plaintext highlighter-rouge">PG_mappedtodisk</code>. All this flag signifies is that the contents of the page correlated to blocks on the disk. We will get into this a lot more as we discuss page cache. This flag is usually when a page is read from disk.</p><p>The fifth bit is <code class="language-plaintext highlighter-rouge">PG_writeback</code>. <code class="language-plaintext highlighter-rouge">PG_writeback</code> represents pages that are currently under some disk IO. Pages under writeback should not be modified.</p><p>The sixth bit of importance is <code class="language-plaintext highlighter-rouge">PG_locked</code>. Contrary to what it sounds like, <code class="language-plaintext highlighter-rouge">PG_locked</code> does not lock the actual memory that the <code class="language-plaintext highlighter-rouge">struct page</code> describes. Rather, it is a lock on the fields in a <code class="language-plaintext highlighter-rouge">struct page</code>. Thus, any process wanting to modify a <code class="language-plaintext highlighter-rouge">struct page</code> should hold the lock, and this flag should be set.</p><p>The next field (Or set of fields rather) is the anonymous struct that contains the page cache information:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="p">{</span>	<span class="cm">/* Page cache and anonymous pages */</span>
			<span class="cm">/**
			 * @lru: Pageout list, eg. active_list protected by
			 * lruvec-&gt;lru_lock.  Sometimes used as a generic list
			 * by the page owner.
			 
			struct list_head lru;
			/* See page-flags.h for PAGE_MAPPING_FLAGS */</span>
			<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
			<span class="n">pgoff_t</span> <span class="n">index</span><span class="p">;</span>		<span class="cm">/* Our offset within mapping. */</span>
			<span class="cm">/**
			 * @private: Mapping-private opaque data.
			 * Usually used for buffer_heads if PagePrivate.
			 * Used for swp_entry_t if PageSwapCache.
			 * Indicates order in the buddy system if PageBuddy.
			 */</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">private</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p>The first field in this anonymous struct is the LRU. The LRU is a very important data structure that deals with page eviction. To my very limited understanding of LRU, there are two lists: active and inactive. Pages in the active list have been accessed very recently, and pages in the inactive list have not been accessed recently. Based on this LRU list, the Linux kernel makes heuristic decisions on whether to flush or keep any page. The LRU list will not be of concern for QogChamp.</p><p>The second field is <code class="language-plaintext highlighter-rouge">struct address_space</code>. This is a particularly interesting field as it can actually be two things. If the page is file-mapped, then the <code class="language-plaintext highlighter-rouge">struct address_space</code> field will point to a <code class="language-plaintext highlighter-rouge">struct address_space</code>, which contains information on file-mapped shared pages. However, if the page is anonymous (Not file-backed), then it will actually point to a <code class="language-plaintext highlighter-rouge">struct anon_vma</code> as evidenced in <a href="https://elixir.bootlin.com/linux/v5.14/source/mm/rmap.c#L1068">this</a> function, which is a descendant of the anonymous page fault handler. <code class="language-plaintext highlighter-rouge">struct anon_vma</code> is used to keep track of shared anonymous mappings. Only <code class="language-plaintext highlighter-rouge">struct address_space</code> will be of concern for QogChamp.</p><p>The third field is <code class="language-plaintext highlighter-rouge">index</code>. The index field is used to describe the page’s index within the <code class="language-plaintext highlighter-rouge">mapping</code> field. It works almost in the same way that an index into an array works.</p><p>The final field is <code class="language-plaintext highlighter-rouge">private</code>. The <code class="language-plaintext highlighter-rouge">private</code> field is only set if the <code class="language-plaintext highlighter-rouge">PG_private</code> flag is set. If <code class="language-plaintext highlighter-rouge">PG_private</code> is set, the <code class="language-plaintext highlighter-rouge">private</code> field will contain a pointer to the <code class="language-plaintext highlighter-rouge">struct buffer_head</code>s. This is something that we will go into when we discuss page caches.</p><p>The next two fields within the <code class="language-plaintext highlighter-rouge">struct page</code> of importance are <code class="language-plaintext highlighter-rouge">_mapcount</code> and <code class="language-plaintext highlighter-rouge">_refcount</code>. <code class="language-plaintext highlighter-rouge">_refcount</code> is exactly what it sounds like - the number of references held to the <code class="language-plaintext highlighter-rouge">struct page</code>. Typically, this is increased and decreased via the <code class="language-plaintext highlighter-rouge">get_page</code> and <code class="language-plaintext highlighter-rouge">put_page</code> functions, respectively.</p><p><code class="language-plaintext highlighter-rouge">_mapcount</code>, on the other hand, is a counter of how many times the page has been mapped to userspace (i.e., how many page tables the page is in). Put simply, <code class="language-plaintext highlighter-rouge">_refcount</code> is the number of references held to the <code class="language-plaintext highlighter-rouge">struct page</code>, and <code class="language-plaintext highlighter-rouge">_mapcount</code> is the number of virtual references held to the page. The page eviction code often uses these two variables to see when a page is safe to evict. These two fields will not be very important, but I felt that I should mention them because they are such ubiquitous variables.</p><h2 id="whats-next">What’s next</h2><p>From here, I will try to explain the page cache and how it functions as well as the syscalls that will be important.</p><h2 id="references">References</h2><p>Page walk image - Intel Developer Manual Volume 3A page 4-20</p><p>Paging data structures image - Intel Developer Manual Volume 3A page 4-18</p><p><code class="language-plaintext highlighter-rouge">struct page</code> - <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/mm_types.h#L70">https://elixir.bootlin.com/linux/latest/source/include/linux/mm_types.h#L70</a></p><p><code class="language-plaintext highlighter-rouge">anon_vma</code> - <a href="https://lwn.net/Articles/75405/">https://lwn.net/Articles/75405/</a></p><p><code class="language-plaintext highlighter-rouge">_mapcount</code> and <code class="language-plaintext highlighter-rouge">_refcount</code> - <a href="https://stackoverflow.com/questions/48931940/how-do-pinned-pages-in-linux-present-or-actually-pin-themselves">https://stackoverflow.com/questions/48931940/how-do-pinned-pages-in-linux-present-or-actually-pin-themselves</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/qogchamp/'>QogChamp</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux-kernel-exploitation/" class="post-tag no-text-decoration" >Linux Kernel Exploitation</a> <a href="/tags/paging/" class="post-tag no-text-decoration" >Paging</a> <a href="/tags/mm/" class="post-tag no-text-decoration" >MM</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Paging in the Linux Kernel - mineo333/Sharad Khanna&url=https://mineo333.dev/posts/2-paging-in-the-linux-kernel/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Paging in the Linux Kernel - mineo333/Sharad Khanna&u=https://mineo333.dev/posts/2-paging-in-the-linux-kernel/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Paging in the Linux Kernel - mineo333/Sharad Khanna&url=https://mineo333.dev/posts/2-paging-in-the-linux-kernel/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/4-sync-and-writeback/">sync and Writeback</a><li><a href="/posts/1-beginnings/">Beginnings</a><li><a href="/posts/2-paging-in-the-linux-kernel/">Paging in the Linux Kernel</a><li><a href="/posts/3-linux-kernel-page-cache/">Linux Kernel Page Cache</a><li><a href="/posts/what-is-qogchamp/">What is QogChamp?</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux-kernel-exploitation/">Linux Kernel Exploitation</a> <a class="post-tag" href="/tags/syscall/">Syscall</a> <a class="post-tag" href="/tags/mm/">MM</a> <a class="post-tag" href="/tags/page-cache/">Page Cache</a> <a class="post-tag" href="/tags/paging/">Paging</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/what-is-qogchamp/"><div class="card-body"> <span class="timeago small" >Oct 26, 2021<i class="unloaded">2021-10-26T13:46:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>What is QogChamp?</h3><div class="text-muted small"><p> So, the primary reason I made this blog was to document and discuss the logic and code behind my rootkit: QogChamp. In this post, I want to answer the simple question: What is QogChamp? Through th...</p></div></div></a></div><div class="card"> <a href="/posts/1-beginnings/"><div class="card-body"> <span class="timeago small" >Oct 26, 2021<i class="unloaded">2021-10-26T16:30:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Beginnings</h3><div class="text-muted small"><p> In this post, I hope to tell you about how QogChamp started and what the original codebase looked like. This will be a fairly brief post and won’t get too much into the codebase as the functions us...</p></div></div></a></div><div class="card"> <a href="/posts/3-linux-kernel-page-cache/"><div class="card-body"> <span class="timeago small" >Nov 8, 2021<i class="unloaded">2021-11-08T15:40:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Page Cache</h3><div class="text-muted small"><p> One of QogChamp’s capabilities is performing “ghost file operations” or file operations that are easy to clean up and have little to no footprint. The page cache is the main structure used to pull ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/1-beginnings/" class="btn btn-outline-primary" prompt="Older"><p>Beginnings</p></a> <a href="/posts/3-linux-kernel-page-cache/" class="btn btn-outline-primary" prompt="Newer"><p>Linux Kernel Page Cache</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="">mineo333/Sharad Khanna</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux-kernel-exploitation/">Linux Kernel Exploitation</a> <a class="post-tag" href="/tags/syscall/">Syscall</a> <a class="post-tag" href="/tags/mm/">MM</a> <a class="post-tag" href="/tags/page-cache/">Page Cache</a> <a class="post-tag" href="/tags/paging/">Paging</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
